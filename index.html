<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FairFees ‚Äî Launch Your Token</title>
<script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.min.js"></script>
<style>
  :root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #21262d;
    --border: #30363d;
    --text-primary: #e6edf3;
    --text-secondary: #8b949e;
    --text-muted: #484f58;
    --green: #3fb950;
    --green-bg: rgba(63,185,80,0.12);
    --red: #f85149;
    --yellow: #d29922;
    --blue: #58a6ff;
    --purple: #bc8cff;
    --mono: 'SF Mono','Cascadia Code','Fira Code','Consolas',monospace;
    --sans: -apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg-primary); color:var(--text-primary); font-family:var(--sans); font-size:14px; min-height:100vh; }
  a { color:var(--blue); text-decoration:none; }
  a:hover { text-decoration:underline; }

  /* Header */
  .header {
    position:fixed; top:0; left:0; right:0; height:56px; z-index:50;
    background:var(--bg-secondary); border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; padding:0 24px;
  }
  .logo {
    font-size:20px; font-weight:700;
    background:linear-gradient(135deg, var(--blue), var(--purple));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  }
  .wallet-btn {
    background:var(--green-bg); color:var(--green); border:1px solid rgba(63,185,80,0.3);
    border-radius:8px; padding:8px 16px; cursor:pointer; font-size:13px; font-weight:600;
    font-family:var(--sans); transition:all 0.15s;
  }
  .wallet-btn:hover { background:rgba(63,185,80,0.2); }
  .wallet-btn.connected { background:var(--bg-tertiary); color:var(--text-primary); border-color:var(--border); }
  .wallet-addr { font-family:var(--mono); font-size:12px; }

  /* Main */
  .main { margin-top:56px; padding:40px 20px 60px; max-width:680px; margin-left:auto; margin-right:auto; }

  /* Hero */
  .hero { text-align:center; margin-bottom:48px; }
  .hero h1 { font-size:36px; font-weight:800; margin-bottom:12px; line-height:1.2; }
  .hero p { color:var(--text-secondary); font-size:16px; line-height:1.6; max-width:520px; margin:0 auto 24px; }
  .badges { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
  .badge {
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 14px; border-radius:20px; font-size:12px; font-weight:600;
    background:var(--bg-secondary); border:1px solid var(--border); color:var(--text-secondary);
  }
  .badge-dot { width:6px; height:6px; border-radius:50%; background:var(--green); }

  /* Card */
  .card {
    background:var(--bg-secondary); border:1px solid var(--border);
    border-radius:12px; padding:28px; margin-bottom:24px;
  }
  .card h2 { font-size:18px; font-weight:700; margin-bottom:20px; }

  /* Form */
  .form-group { margin-bottom:18px; }
  .form-group label { display:block; font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:6px; }
  .form-group .hint { font-size:11px; color:var(--text-muted); margin-top:4px; }
  .form-input {
    width:100%; background:var(--bg-primary); border:1px solid var(--border); border-radius:8px;
    color:var(--text-primary); padding:10px 14px; font-size:14px; font-family:var(--sans); outline:none;
    transition:border-color 0.15s;
  }
  .form-input:focus { border-color:var(--blue); }
  .form-input::placeholder { color:var(--text-muted); }
  textarea.form-input { resize:vertical; min-height:80px; }

  /* Image upload */
  .image-upload {
    border:2px dashed var(--border); border-radius:8px; padding:24px;
    text-align:center; cursor:pointer; transition:border-color 0.15s;
    position:relative; overflow:hidden;
  }
  .image-upload:hover, .image-upload.dragover { border-color:var(--blue); }
  .image-upload input[type="file"] { position:absolute; inset:0; opacity:0; cursor:pointer; }
  .image-upload-text { color:var(--text-muted); font-size:13px; }
  .image-upload-text strong { color:var(--text-secondary); }
  .image-preview {
    width:80px; height:80px; border-radius:8px; object-fit:cover;
    margin:0 auto 8px; display:none;
  }

  /* Socials row */
  .socials-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
  @media (max-width:600px) { .socials-row { grid-template-columns:1fr; } }

  /* Launch button */
  .launch-btn {
    width:100%; padding:14px; border:none; border-radius:10px; cursor:pointer;
    font-size:16px; font-weight:700; font-family:var(--sans);
    background:var(--green); color:#fff; transition:opacity 0.15s;
  }
  .launch-btn:hover:not(:disabled) { opacity:0.9; }
  .launch-btn:disabled { opacity:0.4; cursor:not-allowed; }

  /* Progress */
  .progress { margin-top:24px; }
  .progress.hidden { display:none; }
  .step {
    display:flex; align-items:center; gap:10px; padding:10px 0;
    font-size:13px; color:var(--text-muted);
  }
  .step.active { color:var(--text-primary); }
  .step.done { color:var(--green); }
  .step.error { color:var(--red); }
  .step-icon {
    width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center;
    font-size:12px; flex-shrink:0;
    background:var(--bg-tertiary); border:1px solid var(--border); color:var(--text-muted);
  }
  .step.active .step-icon { border-color:var(--blue); color:var(--blue); }
  .step.done .step-icon { background:var(--green-bg); border-color:var(--green); color:var(--green); }
  .step.error .step-icon { background:rgba(248,81,73,0.12); border-color:var(--red); color:var(--red); }
  @keyframes spin { to { transform:rotate(360deg); } }
  .spinner { animation:spin 1s linear infinite; display:inline-block; }

  /* Success */
  .success-card { text-align:center; }
  .success-card .checkmark { font-size:48px; margin-bottom:12px; }
  .success-card h2 { color:var(--green); margin-bottom:16px; }
  .mint-addr {
    font-family:var(--mono); font-size:13px; background:var(--bg-primary);
    border:1px solid var(--border); border-radius:8px; padding:12px 16px;
    word-break:break-all; margin:12px 0; cursor:pointer; transition:border-color 0.15s;
  }
  .mint-addr:hover { border-color:var(--blue); }
  .success-links { display:flex; gap:12px; justify-content:center; margin:16px 0; flex-wrap:wrap; }
  .success-links a {
    padding:8px 16px; border-radius:8px; font-size:13px; font-weight:600;
    background:var(--bg-tertiary); border:1px solid var(--border); color:var(--text-primary);
  }
  .success-links a:hover { border-color:var(--blue); text-decoration:none; }
  .fairfees-badge {
    display:inline-flex; align-items:center; gap:6px; margin-top:16px;
    padding:8px 16px; border-radius:20px; font-size:12px; font-weight:600;
    background:var(--green-bg); border:1px solid rgba(63,185,80,0.3); color:var(--green);
  }
  .btn-secondary {
    background:var(--bg-tertiary); color:var(--text-primary); border:1px solid var(--border);
    border-radius:8px; padding:10px 20px; cursor:pointer; font-size:14px; font-weight:600;
    font-family:var(--sans); margin-top:20px;
  }
  .btn-secondary:hover { background:var(--border); }

  /* Error */
  .error-msg {
    background:rgba(248,81,73,0.1); border:1px solid rgba(248,81,73,0.3);
    border-radius:8px; padding:12px 16px; color:var(--red); font-size:13px;
    margin-top:12px; display:none;
  }

  /* No Phantom */
  .no-phantom {
    text-align:center; padding:40px 20px; color:var(--text-secondary);
  }
  .no-phantom a {
    display:inline-block; margin-top:12px; padding:10px 24px;
    background:rgba(88,166,255,0.15); color:var(--blue); border:1px solid rgba(88,166,255,0.3);
    border-radius:8px; font-weight:600;
  }

  /* Footer */
  .footer {
    text-align:center; padding:32px 20px; color:var(--text-muted); font-size:12px;
    line-height:1.6; border-top:1px solid var(--border); max-width:680px; margin:40px auto 0;
  }
  .footer strong { color:var(--text-secondary); }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <span class="logo">FairFees</span>
  <button class="wallet-btn" id="wallet-btn" onclick="toggleWallet()">Connect Wallet</button>
</div>

<!-- Main -->
<div class="main">

  <!-- Hero -->
  <div class="hero">
    <h1>Launch Your FairFees Token</h1>
    <p>Create a token on PumpFun where creator fees are redistributed fairly to holders. Compensate losses, reward diamond hands.</p>
    <div class="badges">
      <span class="badge"><span class="badge-dot"></span> Fees &rarr; Holders</span>
      <span class="badge"><span class="badge-dot"></span> Real-Time Tracking</span>
      <span class="badge"><span class="badge-dot"></span> Transparent Dashboard</span>
    </div>
  </div>

  <!-- Form Card -->
  <div class="card" id="form-card">
    <h2>Token Details</h2>

    <div class="form-group">
      <label>Name *</label>
      <input type="text" class="form-input" id="token-name" placeholder="e.g. FairDoge" maxlength="32" />
    </div>

    <div class="form-group">
      <label>Symbol *</label>
      <input type="text" class="form-input" id="token-symbol" placeholder="e.g. FDOGE" maxlength="10" style="text-transform:uppercase" />
    </div>

    <div class="form-group">
      <label>Description *</label>
      <textarea class="form-input" id="token-description" placeholder="Describe your token and its mission..."></textarea>
    </div>

    <div class="form-group">
      <label>Image *</label>
      <div class="image-upload" id="image-upload">
        <img class="image-preview" id="image-preview" />
        <div class="image-upload-text" id="image-upload-text">
          <strong>Click to upload</strong> or drag and drop<br/>PNG, JPG, GIF (max 5MB)
        </div>
        <input type="file" id="token-image" accept="image/png,image/jpeg,image/gif,image/webp" />
      </div>
    </div>

    <div class="form-group">
      <label>Social Links (optional)</label>
      <div class="socials-row">
        <input type="text" class="form-input" id="token-twitter" placeholder="Twitter URL" />
        <input type="text" class="form-input" id="token-telegram" placeholder="Telegram URL" />
        <input type="text" class="form-input" id="token-website" placeholder="Website URL" />
      </div>
    </div>

    <button class="launch-btn" id="launch-btn" disabled onclick="launchToken()">Connect Wallet to Launch</button>

    <div class="error-msg" id="error-msg"></div>

    <!-- Progress Steps -->
    <div class="progress hidden" id="progress">
      <div class="step" id="step-1"><span class="step-icon">1</span> Uploading metadata to IPFS...</div>
      <div class="step" id="step-2"><span class="step-icon">2</span> Building transaction...</div>
      <div class="step" id="step-3"><span class="step-icon">3</span> Please approve in your wallet...</div>
      <div class="step" id="step-4"><span class="step-icon">4</span> Sending transaction...</div>
      <div class="step" id="step-5"><span class="step-icon">5</span> Confirming on-chain...</div>
    </div>
  </div>

  <!-- Success Card (hidden) -->
  <div class="card success-card hidden" id="success-card">
    <div class="checkmark">&#10003;</div>
    <h2>Token Launched Successfully!</h2>
    <p style="color:var(--text-secondary);margin-bottom:12px">Your FairFees token is now live on PumpFun</p>
    <div class="mint-addr" id="mint-addr" onclick="copyMint()" title="Click to copy">--</div>
    <div class="success-links">
      <a id="link-pump" href="#" target="_blank">View on PumpFun</a>
      <a id="link-scan" href="#" target="_blank">View on Solscan</a>
    </div>
    <div class="fairfees-badge"><span class="badge-dot"></span> FairFees Verified &mdash; Creator fees will be redistributed to holders</div>
    <button class="btn-secondary" onclick="resetForm()">Launch Another Token</button>
  </div>

  <!-- How it works -->
  <div class="card" style="margin-top:8px">
    <h2>How FairFees Works</h2>
    <div style="display:grid;gap:16px;margin-top:8px">
      <div style="display:flex;gap:12px;align-items:flex-start">
        <span style="background:var(--green-bg);border:1px solid rgba(63,185,80,0.3);color:var(--green);border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-weight:700;font-size:14px">1</span>
        <div><strong>Launch</strong><br/><span style="color:var(--text-secondary);font-size:13px">Create your token on PumpFun. It goes live instantly on the bonding curve.</span></div>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <span style="background:var(--green-bg);border:1px solid rgba(63,185,80,0.3);color:var(--green);border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-weight:700;font-size:14px">2</span>
        <div><strong>Trade</strong><br/><span style="color:var(--text-secondary);font-size:13px">Traders buy and sell your token. Creator fees accumulate in SOL in your wallet.</span></div>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <span style="background:var(--green-bg);border:1px solid rgba(63,185,80,0.3);color:var(--green);border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-weight:700;font-size:14px">3</span>
        <div><strong>Redistribute</strong><br/><span style="color:var(--text-secondary);font-size:13px">FairFees Bot redistributes creator fees to holders in loss and diamond hands automatically.</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<div class="footer">
  <strong>Powered by FairFees</strong> &mdash; The first PnL-based fee redistribution system for PumpFun tokens.<br/>
  Holders in loss receive compensation. Diamond hands get rewarded. Fair for everyone.<br/><br/>
  <span style="font-size:11px">Fee redistribution requires the FairFees Bot to be configured with your token's mint address after launch. The launcher creates standard PumpFun tokens.</span>
</div>

<script>
console.log('üöÄ FairFees script loading...');
console.log('solanaWeb3 available:', typeof solanaWeb3 !== 'undefined');
(function() {
  'use strict';

  // ‚îÄ‚îÄ bs58 encoder ‚îÄ‚îÄ
  const BS58_ALPHA = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
  function bs58Encode(bytes) {
    const digits = [0];
    for (let i = 0; i < bytes.length; i++) {
      let carry = bytes[i];
      for (let j = 0; j < digits.length; j++) {
        carry += digits[j] << 8;
        digits[j] = carry % 58;
        carry = (carry / 58) | 0;
      }
      while (carry > 0) { digits.push(carry % 58); carry = (carry / 58) | 0; }
    }
    let str = '';
    for (let i = 0; i < bytes.length && bytes[i] === 0; i++) str += '1';
    for (let i = digits.length - 1; i >= 0; i--) str += BS58_ALPHA[digits[i]];
    return str;
  }

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  const state = {
    provider: null,
    publicKey: null,
    connected: false,
    launching: false,
    mintKeypair: null,
    mintAddress: null,
    txSignature: null,
  };

  // ‚îÄ‚îÄ Phantom Wallet ‚îÄ‚îÄ
  function getProvider() {
    console.log('[Wallet] Checking for Phantom...');
    console.log('[Wallet] window.phantom:', typeof window.phantom, window.phantom ? 'exists' : 'missing');
    console.log('[Wallet] window.phantom?.solana:', typeof window.phantom?.solana, window.phantom?.solana ? 'exists' : 'missing');
    console.log('[Wallet] window.phantom?.solana?.isPhantom:', window.phantom?.solana?.isPhantom);
    console.log('[Wallet] window.solana:', typeof window.solana, window.solana ? 'exists' : 'missing');
    console.log('[Wallet] window.solana?.isPhantom:', window.solana?.isPhantom);

    if (window.phantom?.solana?.isPhantom) {
      console.log('[Wallet] ‚úÖ Found Phantom via window.phantom.solana');
      return window.phantom.solana;
    }
    if (window.solana?.isPhantom) {
      console.log('[Wallet] ‚úÖ Found Phantom via window.solana');
      return window.solana;
    }
    console.log('[Wallet] ‚ùå Phantom NOT found');
    return null;
  }

  window.toggleWallet = async function() {
    console.log('[Wallet] toggleWallet called, connected:', state.connected);

    if (state.connected) {
      try { await state.provider.disconnect(); } catch {}
      state.provider = null;
      state.publicKey = null;
      state.connected = false;
      updateWalletUI();
      return;
    }

    const provider = getProvider();
    if (!provider) {
      console.log('[Wallet] ‚ùå No provider found, opening phantom.app');
      showError('Phantom wallet not detected. Make sure the extension is installed and enabled for this site.');
      return;
    }

    try {
      console.log('[Wallet] Calling provider.connect()...');
      const resp = await provider.connect();
      console.log('[Wallet] ‚úÖ Connected! Public key:', resp.publicKey.toBase58());
      state.provider = provider;
      state.publicKey = resp.publicKey;
      state.connected = true;
      updateWalletUI();
    } catch (err) {
      console.error('[Wallet] ‚ùå Connection error:', err);
      console.error('[Wallet] Error code:', err.code);
      console.error('[Wallet] Error message:', err.message);
      if (err.code === 4001 || (err.message && err.message.includes('rejected'))) {
        showError('Connection rejected. Please approve the connection in Phantom.');
      } else {
        showError('Wallet error: ' + (err.message || JSON.stringify(err)));
      }
    }
  };

  function updateWalletUI() {
    const btn = document.getElementById('wallet-btn');
    const launchBtn = document.getElementById('launch-btn');
    if (state.connected) {
      const addr = state.publicKey.toBase58();
      btn.innerHTML = '<span class="wallet-addr">' + addr.slice(0, 4) + '...' + addr.slice(-4) + '</span>';
      btn.classList.add('connected');
      launchBtn.textContent = 'Launch Token';
      validateForm();
    } else {
      btn.textContent = getProvider() ? 'Connect Wallet' : 'Install Phantom';
      btn.classList.remove('connected');
      launchBtn.textContent = 'Connect Wallet to Launch';
      launchBtn.disabled = true;
    }
  }

  // ‚îÄ‚îÄ Form Validation ‚îÄ‚îÄ
  function validateForm() {
    const btn = document.getElementById('launch-btn');
    if (!state.connected || state.launching) { btn.disabled = true; return; }
    const name = document.getElementById('token-name').value.trim();
    const symbol = document.getElementById('token-symbol').value.trim();
    const desc = document.getElementById('token-description').value.trim();
    const file = document.getElementById('token-image').files[0];
    btn.disabled = !(name && symbol && desc && file);
  }

  ['token-name', 'token-symbol', 'token-description'].forEach(id => {
    document.getElementById(id).addEventListener('input', validateForm);
  });
  document.getElementById('token-image').addEventListener('change', function() {
    const file = this.files[0];
    const preview = document.getElementById('image-preview');
    const text = document.getElementById('image-upload-text');
    if (file) {
      if (file.size > 5 * 1024 * 1024) { showError('Image must be under 5MB'); this.value = ''; return; }
      const reader = new FileReader();
      reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; text.innerHTML = '<strong>' + file.name + '</strong>'; };
      reader.readAsDataURL(file);
    } else {
      preview.style.display = 'none';
      text.innerHTML = '<strong>Click to upload</strong> or drag and drop<br/>PNG, JPG, GIF (max 5MB)';
    }
    validateForm();
  });

  // Drag and drop
  const dropZone = document.getElementById('image-upload');
  dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault(); dropZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      const input = document.getElementById('token-image');
      const dt = new DataTransfer(); dt.items.add(file);
      input.files = dt.files;
      input.dispatchEvent(new Event('change'));
    }
  });

  // ‚îÄ‚îÄ Progress UI ‚îÄ‚îÄ
  function showProgress() { document.getElementById('progress').classList.remove('hidden'); }
  function hideProgress() { document.getElementById('progress').classList.add('hidden'); }

  function setStep(n, status) {
    for (let i = 1; i <= 5; i++) {
      const el = document.getElementById('step-' + i);
      el.className = 'step';
      const icon = el.querySelector('.step-icon');
      if (i < n) { el.classList.add('done'); icon.innerHTML = '&#10003;'; }
      else if (i === n) {
        el.classList.add(status === 'error' ? 'error' : 'active');
        icon.innerHTML = status === 'error' ? '&#10007;' : '<span class="spinner">&#9696;</span>';
      }
      else { icon.textContent = i; }
    }
  }

  function completeStep(n) {
    const el = document.getElementById('step-' + n);
    el.className = 'step done';
    el.querySelector('.step-icon').innerHTML = '&#10003;';
  }

  // ‚îÄ‚îÄ Error display ‚îÄ‚îÄ
  function showError(msg) {
    const el = document.getElementById('error-msg');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 8000);
  }
  function hideError() { document.getElementById('error-msg').style.display = 'none'; }

  // ‚îÄ‚îÄ RPC endpoint (public, CORS-friendly) ‚îÄ‚îÄ
  const RPC_ENDPOINTS = [
    'https://solana-rpc.publicnode.com',
    'https://api.mainnet-beta.solana.com',
  ];
  let currentRpcIndex = 0;

  function getConnection() {
    return new solanaWeb3.Connection(RPC_ENDPOINTS[currentRpcIndex], {
      commitment: 'confirmed',
      confirmTransactionInitialTimeout: 60000,
    });
  }

  async function getConnectionWithFallback() {
    for (let i = 0; i < RPC_ENDPOINTS.length; i++) {
      const idx = (currentRpcIndex + i) % RPC_ENDPOINTS.length;
      const conn = new solanaWeb3.Connection(RPC_ENDPOINTS[idx], { commitment: 'confirmed', confirmTransactionInitialTimeout: 60000 });
      try {
        await conn.getLatestBlockhash();
        currentRpcIndex = idx;
        return conn;
      } catch (e) {
        console.warn('RPC ' + RPC_ENDPOINTS[idx] + ' unreachable, trying next...');
      }
    }
    throw new Error('All RPC endpoints are unreachable. Please try again later.');
  }

  // ‚îÄ‚îÄ Upload metadata to IPFS via pump.fun ‚îÄ‚îÄ
  async function uploadMetadata(name, symbol, description, imageFile, twitter, telegram, website) {
    const formData = new FormData();
    formData.append('file', imageFile);
    formData.append('name', name);
    formData.append('symbol', symbol);
    formData.append('description', description);
    formData.append('twitter', twitter || '');
    formData.append('telegram', telegram || '');
    formData.append('website', website || '');
    formData.append('showName', 'true');

    let response;
    try {
      response = await fetch('https://pump.fun/api/ipfs', {
        method: 'POST',
        body: formData,
      });
    } catch (err) {
      throw new Error('IPFS upload failed (network error). pump.fun may be blocking cross-origin requests. Error: ' + err.message);
    }

    if (!response.ok) {
      const text = await response.text().catch(() => '');
      throw new Error('IPFS upload failed (HTTP ' + response.status + '). ' + text);
    }
    const data = await response.json();
    if (!data.metadataUri) {
      throw new Error('IPFS upload returned no metadataUri. Response: ' + JSON.stringify(data));
    }
    return data.metadataUri;
  }

  // ‚îÄ‚îÄ Build transaction via PumpPortal Local API ‚îÄ‚îÄ
  async function buildTransaction(metadataUri, name, symbol, mintKeypair, userPubkey) {
    const body = {
      publicKey: userPubkey.toBase58(),
      action: 'create',
      tokenMetadata: {
        name: name,
        symbol: symbol,
        uri: metadataUri,
      },
      mint: mintKeypair.publicKey.toBase58(),
      denominatedInSol: 'true',
      amount: 0,
      slippage: 10,
      priorityFee: 0.0005,
      pool: 'pump',
    };

    console.log('PumpPortal request body:', JSON.stringify(body, null, 2));

    let response;
    try {
      response = await fetch('https://pumpportal.fun/api/trade-local', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
    } catch (err) {
      throw new Error('PumpPortal API unreachable: ' + err.message);
    }

    if (!response.ok) {
      const text = await response.text().catch(() => '');
      throw new Error('Transaction build failed (HTTP ' + response.status + '): ' + text);
    }

    const txData = await response.arrayBuffer();
    if (txData.byteLength === 0) {
      throw new Error('PumpPortal returned empty transaction data');
    }

    try {
      return solanaWeb3.VersionedTransaction.deserialize(new Uint8Array(txData));
    } catch (err) {
      throw new Error('Failed to deserialize transaction: ' + err.message);
    }
  }

  // ‚îÄ‚îÄ Sign and send ‚îÄ‚îÄ
  async function signAndSend(tx, mintKeypair, connection) {
    // 1. Sign with the mint keypair first (required by PumpFun)
    tx.sign([mintKeypair]);

    // 2. Let Phantom sign with the user's wallet
    const signedTx = await state.provider.signTransaction(tx);

    // 3. Send the fully signed transaction
    const signature = await connection.sendRawTransaction(signedTx.serialize(), {
      skipPreflight: false,
      preflightCommitment: 'confirmed',
      maxRetries: 3,
    });

    console.log('Transaction sent:', signature);

    // 4. Confirm
    const latestBlockhash = await connection.getLatestBlockhash('confirmed');
    const confirmation = await connection.confirmTransaction({
      signature: signature,
      blockhash: latestBlockhash.blockhash,
      lastValidBlockHeight: latestBlockhash.lastValidBlockHeight,
    }, 'confirmed');

    if (confirmation.value.err) {
      throw new Error('Transaction failed on-chain: ' + JSON.stringify(confirmation.value.err));
    }

    return signature;
  }

  // ‚îÄ‚îÄ Track which step we're on for error reporting ‚îÄ‚îÄ
  let currentStep = 0;

  // ‚îÄ‚îÄ Main launch flow ‚îÄ‚îÄ
  window.launchToken = async function() {
    if (state.launching || !state.connected) return;
    state.launching = true;
    currentStep = 0;
    hideError();
    showProgress();

    const launchBtn = document.getElementById('launch-btn');
    launchBtn.disabled = true;
    launchBtn.textContent = 'Launching...';

    const name = document.getElementById('token-name').value.trim();
    const symbol = document.getElementById('token-symbol').value.trim().toUpperCase();
    const description = document.getElementById('token-description').value.trim();
    const imageFile = document.getElementById('token-image').files[0];
    const twitter = document.getElementById('token-twitter').value.trim();
    const telegram = document.getElementById('token-telegram').value.trim();
    const website = document.getElementById('token-website').value.trim();

    try {
      // Step 0: Check balance using fallback RPC
      const connection = await getConnectionWithFallback();
      const balance = await connection.getBalance(state.publicKey);
      const solBalance = balance / solanaWeb3.LAMPORTS_PER_SOL;
      console.log('Wallet balance:', solBalance, 'SOL');
      if (solBalance < 0.02) {
        throw new Error('Insufficient SOL. You need at least 0.02 SOL to create a token. Current balance: ' + solBalance.toFixed(4) + ' SOL');
      }

      // Generate mint keypair
      state.mintKeypair = solanaWeb3.Keypair.generate();
      state.mintAddress = state.mintKeypair.publicKey.toBase58();
      console.log('Mint address:', state.mintAddress);

      // Step 1: Upload metadata to IPFS
      currentStep = 1;
      setStep(1, 'active');
      const metadataUri = await uploadMetadata(name, symbol, description, imageFile, twitter, telegram, website);
      console.log('Metadata URI:', metadataUri);
      completeStep(1);

      // Step 2: Build transaction via PumpPortal
      currentStep = 2;
      setStep(2, 'active');
      const tx = await buildTransaction(metadataUri, name, symbol, state.mintKeypair, state.publicKey);
      console.log('Transaction built successfully');
      completeStep(2);

      // Step 3: Wallet approval (Phantom signs)
      currentStep = 3;
      setStep(3, 'active');

      // Step 4: Send transaction
      currentStep = 4;
      state.txSignature = await signAndSend(tx, state.mintKeypair, connection);
      completeStep(3);
      setStep(4, 'active');
      completeStep(4);

      // Step 5: Confirmed
      currentStep = 5;
      setStep(5, 'active');
      completeStep(5);

      console.log('Token launched! Signature:', state.txSignature);

      // Show success
      showSuccess();

    } catch (err) {
      const msg = err.message || 'Unknown error';
      console.error('Launch error at step ' + currentStep + ':', err);

      if (msg.includes('User rejected') || msg.includes('user rejected')) {
        showError('Transaction rejected in wallet');
        if (currentStep >= 3) setStep(3, 'error');
      } else {
        showError(msg);
        if (currentStep > 0) setStep(currentStep, 'error');
      }
    } finally {
      state.launching = false;
      launchBtn.disabled = false;
      launchBtn.textContent = 'Launch Token';
      validateForm();
    }
  };

  // ‚îÄ‚îÄ Success screen ‚îÄ‚îÄ
  function showSuccess() {
    document.getElementById('form-card').classList.add('hidden');
    const card = document.getElementById('success-card');
    card.classList.remove('hidden');
    document.getElementById('mint-addr').textContent = state.mintAddress;
    document.getElementById('link-pump').href = 'https://pump.fun/coin/' + state.mintAddress;
    document.getElementById('link-scan').href = 'https://solscan.io/token/' + state.mintAddress;
  }

  window.copyMint = function() {
    navigator.clipboard.writeText(state.mintAddress).then(() => {
      const el = document.getElementById('mint-addr');
      const original = el.textContent;
      el.textContent = 'Copied!';
      setTimeout(() => { el.textContent = original; }, 1500);
    });
  };

  window.resetForm = function() {
    document.getElementById('success-card').classList.add('hidden');
    document.getElementById('form-card').classList.remove('hidden');
    hideProgress();
    document.getElementById('token-name').value = '';
    document.getElementById('token-symbol').value = '';
    document.getElementById('token-description').value = '';
    document.getElementById('token-image').value = '';
    document.getElementById('image-preview').style.display = 'none';
    document.getElementById('image-upload-text').innerHTML = '<strong>Click to upload</strong> or drag and drop<br/>PNG, JPG, GIF (max 5MB)';
    document.getElementById('token-twitter').value = '';
    document.getElementById('token-telegram').value = '';
    document.getElementById('token-website').value = '';
    state.mintKeypair = null;
    state.mintAddress = null;
    state.txSignature = null;
    for (let i = 1; i <= 5; i++) {
      const el = document.getElementById('step-' + i);
      el.className = 'step';
      el.querySelector('.step-icon').textContent = i;
    }
    validateForm();
  };

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  function initProvider() {
    console.log('[Init] initProvider called');
    const p = getProvider();
    if (p) {
      console.log('[Init] ‚úÖ Provider found, attaching event listeners');
      p.on('accountChanged', (pk) => {
        console.log('[Wallet] Account changed:', pk ? pk.toBase58() : 'disconnected');
        if (pk) { state.publicKey = pk; updateWalletUI(); }
        else { state.connected = false; state.publicKey = null; state.provider = null; updateWalletUI(); }
      });
      p.on('disconnect', () => {
        console.log('[Wallet] Disconnected event');
        state.connected = false; state.publicKey = null; state.provider = null; updateWalletUI();
      });
    } else {
      console.log('[Init] ‚ùå No provider found at init time');
    }
    updateWalletUI();
  }

  // Phantom injects after page load ‚Äî wait for it
  console.log('[Init] Page loaded, checking for Phantom...');
  if (getProvider()) {
    console.log('[Init] Phantom available immediately');
    initProvider();
  } else {
    console.log('[Init] Phantom not available yet, waiting...');
    // Phantom fires this event when ready
    window.addEventListener('phantom#initialized', () => {
      console.log('[Init] phantom#initialized event received');
      initProvider();
    }, { once: true });
    // Fallback: poll for up to 3 seconds
    let attempts = 0;
    const poll = setInterval(() => {
      attempts++;
      if (getProvider()) {
        console.log('[Init] Phantom found after ' + attempts + ' poll attempts (' + (attempts * 200) + 'ms)');
        clearInterval(poll);
        initProvider();
      } else if (attempts >= 15) {
        console.log('[Init] ‚ùå Phantom NOT found after 3s of polling. Extension may not be installed or enabled for this site.');
        clearInterval(poll);
        initProvider();
      }
    }, 200);
  }
})();
</script>
</body>
</html>
