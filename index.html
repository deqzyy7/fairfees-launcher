<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FairFees ‚Äî Launch Your Token</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@solana/web3.js@1.95.5/lib/index.iife.min.js"></script>
<style>
  :root {
    --bg: #060608;
    --bg-card: #0c0c10;
    --bg-input: #111116;
    --border: #1a1a22;
    --border-focus: #00e676;
    --text: #e8e8ec;
    --text-secondary: #7a7a88;
    --text-muted: #44444f;
    --green: #00e676;
    --green-dim: rgba(0,230,118,0.12);
    --green-glow: rgba(0,230,118,0.25);
    --red: #ff4757;
    --font: 'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
    --mono: 'SF Mono','Cascadia Code','Fira Code','Consolas',monospace;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    font-size: 14px;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow-x: hidden;
    position: relative;
  }
  /* Transparent bg when embedded in iframe */
  body.in-iframe { background: transparent; }
  body.in-iframe::before { display: none; }

  /* Subtle radial glow behind card */
  body::before {
    content: '';
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(0,230,118,0.04) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  a { color: var(--green); text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* ‚îÄ‚îÄ Container ‚îÄ‚îÄ */
  .container {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 480px;
    padding: 20px;
    margin: 40px auto;
  }

  /* ‚îÄ‚îÄ Branding ‚îÄ‚îÄ */
  .brand {
    text-align: center;
    margin-bottom: 32px;
    opacity: 0;
    animation: fadeSlideDown 0.6s ease forwards;
  }
  .brand h1 {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: #fff;
  }
  .brand h1 span {
    background: linear-gradient(135deg, var(--green), #69f0ae);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .brand p {
    color: var(--text-secondary);
    font-size: 13px;
    margin-top: 6px;
  }

  /* ‚îÄ‚îÄ Wallet button ‚îÄ‚îÄ */
  .wallet-bar {
    display: flex;
    justify-content: center;
    margin-bottom: 24px;
    opacity: 0;
    animation: fadeSlideDown 0.6s ease 0.1s forwards;
  }
  .wallet-btn {
    background: var(--green-dim);
    color: var(--green);
    border: 1px solid rgba(0,230,118,0.2);
    border-radius: 10px;
    padding: 10px 24px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    font-family: var(--font);
    transition: all 0.2s ease;
    letter-spacing: 0.3px;
  }
  .wallet-btn:hover {
    background: rgba(0,230,118,0.18);
    border-color: rgba(0,230,118,0.4);
    box-shadow: 0 0 20px rgba(0,230,118,0.1);
  }
  .wallet-btn.connected {
    background: var(--bg-input);
    color: var(--text);
    border-color: var(--border);
  }
  .wallet-addr { font-family: var(--mono); font-size: 12px; }

  /* ‚îÄ‚îÄ Steps wrapper ‚îÄ‚îÄ */
  .step-view {
    position: relative;
  }

  /* ‚îÄ‚îÄ Sections (form / progress / success) ‚îÄ‚îÄ */
  .section {
    opacity: 0;
    transform: translateY(12px);
    transition: opacity 0.4s ease, transform 0.4s ease;
    display: none;
  }
  .section.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
  }
  .section.exit {
    opacity: 0;
    transform: translateY(-12px);
    pointer-events: none;
  }

  /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    position: relative;
    overflow: hidden;
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(0,230,118,0.15), transparent);
  }

  /* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
  .form-group {
    margin-bottom: 18px;
    opacity: 0;
    animation: fadeSlideUp 0.4s ease forwards;
  }
  .form-group:nth-child(1) { animation-delay: 0.15s; }
  .form-group:nth-child(2) { animation-delay: 0.2s; }
  .form-group:nth-child(3) { animation-delay: 0.25s; }
  .form-group:nth-child(4) { animation-delay: 0.3s; }
  .form-group:nth-child(5) { animation-delay: 0.35s; }
  .form-group:nth-child(6) { animation-delay: 0.4s; }
  .form-group:nth-child(7) { animation-delay: 0.45s; }

  .form-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .form-input {
    width: 100%;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    padding: 11px 14px;
    font-size: 14px;
    font-family: var(--font);
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .form-input:focus {
    border-color: var(--green);
    box-shadow: 0 0 0 3px var(--green-dim);
  }
  .form-input::placeholder { color: var(--text-muted); }
  textarea.form-input { resize: vertical; min-height: 72px; }

  /* Image upload */
  .image-upload {
    border: 1px dashed var(--border);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .image-upload:hover, .image-upload.dragover {
    border-color: var(--green);
    background: rgba(0,230,118,0.03);
  }
  .image-upload input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .image-upload-text { color: var(--text-muted); font-size: 13px; }
  .image-upload-text strong { color: var(--text-secondary); }
  .image-preview {
    width: 64px; height: 64px; border-radius: 10px; object-fit: cover;
    margin: 0 auto 8px; display: none;
    border: 2px solid var(--border);
  }

  /* Socials row */
  .socials-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
  @media (max-width: 520px) { .socials-row { grid-template-columns: 1fr; } }

  /* Launch button */
  .launch-btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 700;
    font-family: var(--font);
    background: var(--green);
    color: #000;
    transition: all 0.2s;
    letter-spacing: 0.3px;
    margin-top: 4px;
    position: relative;
    overflow: hidden;
  }
  .launch-btn:hover:not(:disabled) {
    box-shadow: 0 0 30px rgba(0,230,118,0.25);
    transform: translateY(-1px);
  }
  .launch-btn:active:not(:disabled) { transform: translateY(0); }
  .launch-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
  }

  /* Error */
  .error-msg {
    background: rgba(255,71,87,0.08);
    border: 1px solid rgba(255,71,87,0.2);
    border-radius: 10px;
    padding: 12px 14px;
    color: var(--red);
    font-size: 13px;
    margin-top: 14px;
    display: none;
  }

  /* ‚îÄ‚îÄ Progress section ‚îÄ‚îÄ */
  .progress-section { padding: 12px 0; }
  .progress-section h3 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 24px;
    text-align: center;
    color: var(--text);
  }

  .step {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 0;
    font-size: 13px;
    color: var(--text-muted);
    border-bottom: 1px solid rgba(255,255,255,0.03);
    transition: color 0.3s, opacity 0.3s;
  }
  .step:last-child { border-bottom: none; }
  .step.active { color: var(--text); }
  .step.done { color: var(--green); }
  .step.error { color: var(--red); }

  .step-icon {
    width: 32px; height: 32px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 600;
    flex-shrink: 0;
    background: var(--bg-input);
    border: 1px solid var(--border);
    color: var(--text-muted);
    transition: all 0.3s;
  }
  .step.active .step-icon {
    border-color: var(--green);
    color: var(--green);
    box-shadow: 0 0 12px var(--green-dim);
  }
  .step.done .step-icon {
    background: var(--green-dim);
    border-color: var(--green);
    color: var(--green);
  }
  .step.error .step-icon {
    background: rgba(255,71,87,0.1);
    border-color: var(--red);
    color: var(--red);
  }

  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner { animation: spin 0.8s linear infinite; display: inline-block; }

  /* ‚îÄ‚îÄ Success section ‚îÄ‚îÄ */
  .success-section { text-align: center; padding: 12px 0; }

  .success-icon {
    width: 64px; height: 64px;
    border-radius: 50%;
    background: var(--green-dim);
    border: 2px solid rgba(0,230,118,0.3);
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 20px;
    font-size: 28px;
    color: var(--green);
    animation: successPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    box-shadow: 0 0 40px rgba(0,230,118,0.15);
  }

  .success-section h3 {
    font-size: 20px;
    font-weight: 700;
    color: var(--green);
    margin-bottom: 6px;
  }
  .success-section .subtitle {
    color: var(--text-secondary);
    font-size: 13px;
    margin-bottom: 20px;
  }

  .mint-addr {
    font-family: var(--mono);
    font-size: 12px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 14px;
    word-break: break-all;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: var(--text-secondary);
  }
  .mint-addr:hover {
    border-color: var(--green);
    color: var(--text);
  }

  .success-links {
    display: flex; gap: 10px; justify-content: center;
    margin: 16px 0; flex-wrap: wrap;
  }
  .success-links a {
    padding: 9px 18px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    background: var(--bg-input);
    border: 1px solid var(--border);
    color: var(--text);
    transition: all 0.2s;
  }
  .success-links a:hover {
    border-color: var(--green);
    text-decoration: none;
    box-shadow: 0 0 12px var(--green-dim);
  }

  .fairfees-badge {
    display: inline-flex; align-items: center; gap: 6px;
    margin-top: 16px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px; font-weight: 600;
    background: var(--green-dim);
    border: 1px solid rgba(0,230,118,0.2);
    color: var(--green);
  }
  .fairfees-badge .dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 6px var(--green);
  }

  .btn-secondary {
    background: var(--bg-input);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    font-family: var(--font);
    margin-top: 20px;
    transition: all 0.2s;
  }
  .btn-secondary:hover {
    border-color: var(--text-muted);
    background: var(--bg-card);
  }

  /* ‚îÄ‚îÄ Powered by ‚îÄ‚îÄ */
  .powered {
    text-align: center;
    margin-top: 24px;
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 0.3px;
    opacity: 0;
    animation: fadeSlideUp 0.5s ease 0.6s forwards;
  }
  .powered span {
    color: var(--green);
    font-weight: 600;
  }

  /* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
  @keyframes fadeSlideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeSlideUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes successPop {
    0% { opacity: 0; transform: scale(0.5); }
    100% { opacity: 1; transform: scale(1); }
  }

  /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
  @media (max-width: 520px) {
    .container { padding: 16px; margin: 20px auto; }
    .card { padding: 22px; border-radius: 14px; }
    .brand h1 { font-size: 24px; }
  }

  /* ‚îÄ‚îÄ Compact mode (iframe) ‚îÄ‚îÄ */
  body.in-iframe { font-size: 12px; min-height: auto; align-items: flex-start; }
  body.in-iframe .container { max-width: 400px; padding: 12px; margin: 8px auto; }
  body.in-iframe .brand { margin-bottom: 16px; }
  body.in-iframe .brand h1 { font-size: 20px; }
  body.in-iframe .brand p { font-size: 11px; margin-top: 4px; }
  body.in-iframe .wallet-bar { margin-bottom: 14px; }
  body.in-iframe .wallet-btn { padding: 7px 16px; font-size: 11px; border-radius: 8px; }
  body.in-iframe .card { padding: 18px; border-radius: 12px; }
  body.in-iframe .form-group { margin-bottom: 12px; }
  body.in-iframe .form-group label { font-size: 10px; margin-bottom: 4px; }
  body.in-iframe .form-input { padding: 8px 10px; font-size: 12px; border-radius: 8px; }
  body.in-iframe textarea.form-input { min-height: 52px; }
  body.in-iframe .image-upload { padding: 14px; border-radius: 8px; }
  body.in-iframe .image-upload-text { font-size: 11px; }
  body.in-iframe .image-preview { width: 48px; height: 48px; border-radius: 8px; }
  body.in-iframe .socials-row { gap: 8px; }
  body.in-iframe .launch-btn { padding: 10px; font-size: 13px; border-radius: 10px; }
  body.in-iframe .error-msg { padding: 8px 10px; font-size: 11px; border-radius: 8px; margin-top: 10px; }
  body.in-iframe .progress-section h3 { font-size: 14px; margin-bottom: 16px; }
  body.in-iframe .step { padding: 10px 0; font-size: 12px; gap: 10px; }
  body.in-iframe .step-icon { width: 26px; height: 26px; font-size: 10px; }
  body.in-iframe .success-icon { width: 48px; height: 48px; font-size: 22px; margin-bottom: 14px; }
  body.in-iframe .success-section h3 { font-size: 16px; }
  body.in-iframe .success-section .subtitle { font-size: 11px; margin-bottom: 14px; }
  body.in-iframe .mint-addr { font-size: 10px; padding: 8px 10px; border-radius: 8px; }
  body.in-iframe .success-links a { padding: 7px 14px; font-size: 11px; border-radius: 8px; }
  body.in-iframe .fairfees-badge { font-size: 10px; padding: 6px 12px; }
  body.in-iframe .btn-secondary { padding: 8px 16px; font-size: 12px; margin-top: 14px; }
  body.in-iframe .powered { margin-top: 14px; font-size: 10px; }
</style>
</head>
<body>

<div class="container">

  <!-- Branding -->
  <div class="brand">
    <h1>Launch on <span>FairFees</span></h1>
    <p>Creator fees redistributed to holders. Fair by default.</p>
  </div>

  <!-- Wallet -->
  <div class="wallet-bar">
    <button class="wallet-btn" id="wallet-btn" onclick="toggleWallet()">Connect Wallet</button>
  </div>

  <!-- Step views -->
  <div class="step-view">

    <!-- STEP 1: Form -->
    <div class="section active" id="section-form">
      <div class="card">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" class="form-input" id="token-name" placeholder="e.g. FairDoge" maxlength="32" />
        </div>

        <div class="form-group">
          <label>Symbol *</label>
          <input type="text" class="form-input" id="token-symbol" placeholder="e.g. FDOGE" maxlength="10" style="text-transform:uppercase" />
        </div>

        <div class="form-group">
          <label>Description *</label>
          <textarea class="form-input" id="token-description" placeholder="Describe your token and its mission..."></textarea>
        </div>

        <div class="form-group">
          <label>Image *</label>
          <div class="image-upload" id="image-upload">
            <img class="image-preview" id="image-preview" />
            <div class="image-upload-text" id="image-upload-text">
              <strong>Click to upload</strong> or drag & drop<br/>PNG, JPG, GIF ‚Äî max 5MB
            </div>
            <input type="file" id="token-image" accept="image/png,image/jpeg,image/gif,image/webp" />
          </div>
        </div>

        <div class="form-group">
          <label>Social Links <span style="font-weight:400;text-transform:none;letter-spacing:0">(optional)</span></label>
          <div class="socials-row">
            <input type="text" class="form-input" id="token-twitter" placeholder="Twitter" />
            <input type="text" class="form-input" id="token-telegram" placeholder="Telegram" />
            <input type="text" class="form-input" id="token-website" placeholder="Website" />
          </div>
        </div>

        <div class="form-group" style="margin-bottom:0">
          <button class="launch-btn" id="launch-btn" disabled onclick="launchToken()">Connect Wallet to Launch</button>
        </div>

        <div class="error-msg" id="error-msg"></div>
      </div>
    </div>

    <!-- STEP 2: Progress -->
    <div class="section" id="section-progress">
      <div class="card">
        <div class="progress-section">
          <h3>Launching your token...</h3>
          <div class="step" id="step-1"><span class="step-icon">1</span> Uploading metadata to IPFS</div>
          <div class="step" id="step-2"><span class="step-icon">2</span> Building transaction</div>
          <div class="step" id="step-3"><span class="step-icon">3</span> Approve in your wallet</div>
          <div class="step" id="step-4"><span class="step-icon">4</span> Sending transaction</div>
          <div class="step" id="step-5"><span class="step-icon">5</span> Confirming on-chain</div>
        </div>
        <div class="error-msg" id="error-msg-progress"></div>
      </div>
    </div>

    <!-- STEP 3: Success -->
    <div class="section" id="section-success">
      <div class="card">
        <div class="success-section">
          <div class="success-icon">‚úì</div>
          <h3>Token Launched!</h3>
          <p class="subtitle">Your FairFees token is live on PumpFun</p>
          <div class="mint-addr" id="mint-addr" onclick="copyMint()" title="Click to copy">--</div>
          <div class="success-links">
            <a id="link-pump" href="#" target="_blank">PumpFun ‚Üó</a>
            <a id="link-scan" href="#" target="_blank">Solscan ‚Üó</a>
          </div>
          <div class="fairfees-badge"><span class="dot"></span> FairFees Verified ‚Äî Fees ‚Üí Holders</div>
          <br/>
          <button class="btn-secondary" onclick="resetForm()">Launch Another Token</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Powered by -->
  <div class="powered">Powered by <span>FairFees</span></div>

</div>

<script>
console.log('üöÄ FairFees script loading...');
console.log('solanaWeb3 available:', typeof solanaWeb3 !== 'undefined');
(function() {
  'use strict';

  // ‚îÄ‚îÄ bs58 encoder ‚îÄ‚îÄ
  const BS58_ALPHA = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
  function bs58Encode(bytes) {
    const digits = [0];
    for (let i = 0; i < bytes.length; i++) {
      let carry = bytes[i];
      for (let j = 0; j < digits.length; j++) {
        carry += digits[j] << 8;
        digits[j] = carry % 58;
        carry = (carry / 58) | 0;
      }
      while (carry > 0) { digits.push(carry % 58); carry = (carry / 58) | 0; }
    }
    let str = '';
    for (let i = 0; i < bytes.length && bytes[i] === 0; i++) str += '1';
    for (let i = digits.length - 1; i >= 0; i--) str += BS58_ALPHA[digits[i]];
    return str;
  }

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  const state = {
    provider: null,
    publicKey: null,
    connected: false,
    launching: false,
    mintKeypair: null,
    mintAddress: null,
    txSignature: null,
  };

  // ‚îÄ‚îÄ Section transitions ‚îÄ‚îÄ
  function showSection(id) {
    const sections = document.querySelectorAll('.section');
    sections.forEach(s => {
      if (s.id === id) {
        s.style.display = 'block';
        // Force reflow for animation
        s.offsetHeight;
        s.classList.add('active');
        s.classList.remove('exit');
      } else if (s.classList.contains('active')) {
        s.classList.add('exit');
        s.classList.remove('active');
        setTimeout(() => {
          s.style.display = 'none';
          s.classList.remove('exit');
        }, 400);
      }
    });
  }

  // ‚îÄ‚îÄ Detect iframe ‚îÄ‚îÄ
  const isInIframe = window.self !== window.top;
  if (isInIframe) {
    document.body.classList.add('in-iframe');
    console.log('[Init] Running inside iframe ‚Äî will open popup for wallet');
  }

  // ‚îÄ‚îÄ Phantom Wallet ‚îÄ‚îÄ
  function getProvider() {
    console.log('[Wallet] Checking for Phantom...');
    if (window.phantom?.solana?.isPhantom) {
      console.log('[Wallet] ‚úÖ Found Phantom via window.phantom.solana');
      return window.phantom.solana;
    }
    if (window.solana?.isPhantom) {
      console.log('[Wallet] ‚úÖ Found Phantom via window.solana');
      return window.solana;
    }
    console.log('[Wallet] ‚ùå Phantom NOT found');
    return null;
  }

  window.toggleWallet = async function() {
    console.log('[Wallet] toggleWallet called, connected:', state.connected);

    if (state.connected) {
      try { await state.provider.disconnect(); } catch {}
      state.provider = null;
      state.publicKey = null;
      state.connected = false;
      updateWalletUI();
      return;
    }

    // If in iframe, Phantom can't inject ‚Äî open in popup
    if (isInIframe && !getProvider()) {
      console.log('[Wallet] In iframe without Phantom ‚Äî opening popup');
      const w = 500, h = 750;
      const left = (screen.width - w) / 2;
      const top = (screen.height - h) / 2;
      window.open(
        window.location.href,
        'fairfees-launcher',
        'width=' + w + ',height=' + h + ',left=' + left + ',top=' + top + ',scrollbars=yes,resizable=yes'
      );
      return;
    }

    const provider = getProvider();
    if (!provider) {
      showError('Phantom wallet not detected. Make sure the extension is installed and enabled for this site.');
      return;
    }

    try {
      console.log('[Wallet] Calling provider.connect()...');
      const resp = await provider.connect();
      console.log('[Wallet] ‚úÖ Connected! Public key:', resp.publicKey.toString());
      state.provider = provider;
      state.publicKey = resp.publicKey;
      state.connected = true;
      updateWalletUI();
    } catch (err) {
      console.error('[Wallet] connect() failed:', err.code, err.message, err);

      // Check if already connected despite the error
      if (provider.publicKey && provider.isConnected) {
        console.log('[Wallet] Provider is actually connected despite error. Using existing session.');
        state.provider = provider;
        state.publicKey = provider.publicKey;
        state.connected = true;
        updateWalletUI();
        return;
      }

      if (err.code === -32603) {
        showError(
          'Phantom internal error (-32603). Fixes: ' +
          '1) In Phantom, switch to a different Solana account (not imported ETH-only), ' +
          '2) Toggle Phantom off/on in chrome://extensions, ' +
          '3) Disable other wallet extensions, ' +
          '4) Restart Chrome.'
        );
      } else if (err.code === 4001) {
        showError('Connection rejected. Please approve the connection in Phantom.');
      } else {
        showError('Connection failed: ' + (err.message || 'Unknown error'));
      }
    }
  };

  function updateWalletUI() {
    const btn = document.getElementById('wallet-btn');
    const launchBtn = document.getElementById('launch-btn');
    if (state.connected) {
      const addr = state.publicKey.toBase58();
      btn.innerHTML = '<span class="wallet-addr">' + addr.slice(0, 4) + '...' + addr.slice(-4) + '</span>';
      btn.classList.add('connected');
      launchBtn.textContent = 'Launch Token';
      validateForm();
    } else {
      btn.textContent = getProvider() ? 'Connect Wallet' : 'Install Phantom';
      btn.classList.remove('connected');
      launchBtn.textContent = 'Connect Wallet to Launch';
      launchBtn.disabled = true;
    }
  }

  // ‚îÄ‚îÄ Form Validation ‚îÄ‚îÄ
  function validateForm() {
    const btn = document.getElementById('launch-btn');
    if (!state.connected || state.launching) { btn.disabled = true; return; }
    const name = document.getElementById('token-name').value.trim();
    const symbol = document.getElementById('token-symbol').value.trim();
    const desc = document.getElementById('token-description').value.trim();
    const file = document.getElementById('token-image').files[0];
    btn.disabled = !(name && symbol && desc && file);
  }

  ['token-name', 'token-symbol', 'token-description'].forEach(id => {
    document.getElementById(id).addEventListener('input', validateForm);
  });
  document.getElementById('token-image').addEventListener('change', function() {
    const file = this.files[0];
    const preview = document.getElementById('image-preview');
    const text = document.getElementById('image-upload-text');
    if (file) {
      if (file.size > 5 * 1024 * 1024) { showError('Image must be under 5MB'); this.value = ''; return; }
      const reader = new FileReader();
      reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; text.innerHTML = '<strong>' + file.name + '</strong>'; };
      reader.readAsDataURL(file);
    } else {
      preview.style.display = 'none';
      text.innerHTML = '<strong>Click to upload</strong> or drag & drop<br/>PNG, JPG, GIF ‚Äî max 5MB';
    }
    validateForm();
  });

  // Drag and drop
  const dropZone = document.getElementById('image-upload');
  dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault(); dropZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      const input = document.getElementById('token-image');
      const dt = new DataTransfer(); dt.items.add(file);
      input.files = dt.files;
      input.dispatchEvent(new Event('change'));
    }
  });

  // ‚îÄ‚îÄ Progress UI ‚îÄ‚îÄ
  function setStep(n, status) {
    for (let i = 1; i <= 5; i++) {
      const el = document.getElementById('step-' + i);
      el.className = 'step';
      const icon = el.querySelector('.step-icon');
      if (i < n) { el.classList.add('done'); icon.innerHTML = '‚úì'; }
      else if (i === n) {
        el.classList.add(status === 'error' ? 'error' : 'active');
        icon.innerHTML = status === 'error' ? '‚úó' : '<span class="spinner">‚óå</span>';
      }
      else { icon.textContent = i; }
    }
  }

  function completeStep(n) {
    const el = document.getElementById('step-' + n);
    el.className = 'step done';
    el.querySelector('.step-icon').innerHTML = '‚úì';
  }

  // ‚îÄ‚îÄ Error display ‚îÄ‚îÄ
  function showError(msg) {
    const el = document.getElementById('error-msg');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 8000);
  }
  function showProgressError(msg) {
    const el = document.getElementById('error-msg-progress');
    el.textContent = msg;
    el.style.display = 'block';
  }
  function hideError() {
    document.getElementById('error-msg').style.display = 'none';
    document.getElementById('error-msg-progress').style.display = 'none';
  }

  // ‚îÄ‚îÄ Backend proxy URL (for IPFS upload ‚Äî pump.fun blocks CORS) ‚îÄ‚îÄ
  const BACKEND_URL = 'https://bot-lelu-production.up.railway.app';

  // ‚îÄ‚îÄ RPC endpoint (public, CORS-friendly) ‚îÄ‚îÄ
  const RPC_ENDPOINTS = [
    'https://solana-rpc.publicnode.com',
    'https://api.mainnet-beta.solana.com',
  ];
  let currentRpcIndex = 0;

  function getConnection() {
    return new solanaWeb3.Connection(RPC_ENDPOINTS[currentRpcIndex], {
      commitment: 'confirmed',
      confirmTransactionInitialTimeout: 60000,
    });
  }

  async function getConnectionWithFallback() {
    for (let i = 0; i < RPC_ENDPOINTS.length; i++) {
      const idx = (currentRpcIndex + i) % RPC_ENDPOINTS.length;
      const conn = new solanaWeb3.Connection(RPC_ENDPOINTS[idx], { commitment: 'confirmed', confirmTransactionInitialTimeout: 60000 });
      try {
        await conn.getLatestBlockhash();
        currentRpcIndex = idx;
        return conn;
      } catch (e) {
        console.warn('RPC ' + RPC_ENDPOINTS[idx] + ' unreachable, trying next...');
      }
    }
    throw new Error('All RPC endpoints are unreachable. Please try again later.');
  }

  // ‚îÄ‚îÄ Upload metadata to IPFS via backend proxy ‚îÄ‚îÄ
  async function uploadMetadata(name, symbol, description, imageFile, twitter, telegram, website) {
    const formData = new FormData();
    formData.append('file', imageFile);
    formData.append('name', name);
    formData.append('symbol', symbol);
    formData.append('description', description);
    formData.append('twitter', twitter || '');
    formData.append('telegram', telegram || '');
    formData.append('website', website || '');
    formData.append('showName', 'true');

    let response;
    try {
      console.log('[IPFS] Uploading via proxy:', BACKEND_URL + '/api/ipfs-proxy');
      response = await fetch(BACKEND_URL + '/api/ipfs-proxy', {
        method: 'POST',
        body: formData,
      });
    } catch (err) {
      throw new Error('IPFS upload failed (network error): ' + err.message);
    }

    if (!response.ok) {
      const text = await response.text().catch(() => '');
      throw new Error('IPFS upload failed (HTTP ' + response.status + '): ' + text);
    }
    const data = await response.json();
    console.log('[IPFS] Response:', data);
    if (!data.metadataUri) {
      throw new Error('IPFS upload returned no metadataUri. Response: ' + JSON.stringify(data));
    }
    return data.metadataUri;
  }

  // ‚îÄ‚îÄ Build transaction via PumpPortal Local API ‚îÄ‚îÄ
  async function buildTransaction(metadataUri, name, symbol, mintKeypair, userPubkey) {
    const body = {
      publicKey: userPubkey.toBase58(),
      action: 'create',
      tokenMetadata: {
        name: name,
        symbol: symbol,
        uri: metadataUri,
      },
      mint: mintKeypair.publicKey.toBase58(),
      denominatedInSol: 'true',
      amount: 0,
      slippage: 10,
      priorityFee: 0.0005,
      pool: 'pump',
    };

    console.log('PumpPortal request body:', JSON.stringify(body, null, 2));

    let response;
    try {
      response = await fetch('https://pumpportal.fun/api/trade-local', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
    } catch (err) {
      throw new Error('PumpPortal API unreachable: ' + err.message);
    }

    if (!response.ok) {
      const text = await response.text().catch(() => '');
      throw new Error('Transaction build failed (HTTP ' + response.status + '): ' + text);
    }

    const txData = await response.arrayBuffer();
    if (txData.byteLength === 0) {
      throw new Error('PumpPortal returned empty transaction data');
    }

    try {
      return solanaWeb3.VersionedTransaction.deserialize(new Uint8Array(txData));
    } catch (err) {
      throw new Error('Failed to deserialize transaction: ' + err.message);
    }
  }

  // ‚îÄ‚îÄ Sign and send ‚îÄ‚îÄ
  async function signAndSend(tx, mintKeypair, connection) {
    tx.sign([mintKeypair]);
    const signedTx = await state.provider.signTransaction(tx);
    const signature = await connection.sendRawTransaction(signedTx.serialize(), {
      skipPreflight: false,
      preflightCommitment: 'confirmed',
      maxRetries: 3,
    });

    console.log('Transaction sent:', signature);

    const latestBlockhash = await connection.getLatestBlockhash('confirmed');
    const confirmation = await connection.confirmTransaction({
      signature: signature,
      blockhash: latestBlockhash.blockhash,
      lastValidBlockHeight: latestBlockhash.lastValidBlockHeight,
    }, 'confirmed');

    if (confirmation.value.err) {
      throw new Error('Transaction failed on-chain: ' + JSON.stringify(confirmation.value.err));
    }

    return signature;
  }

  // ‚îÄ‚îÄ Track current step ‚îÄ‚îÄ
  let currentStep = 0;

  // ‚îÄ‚îÄ Main launch flow ‚îÄ‚îÄ
  window.launchToken = async function() {
    if (state.launching || !state.connected) return;
    state.launching = true;
    currentStep = 0;
    hideError();

    // Transition to progress view
    showSection('section-progress');

    const launchBtn = document.getElementById('launch-btn');
    launchBtn.disabled = true;
    launchBtn.textContent = 'Launching...';

    const name = document.getElementById('token-name').value.trim();
    const symbol = document.getElementById('token-symbol').value.trim().toUpperCase();
    const description = document.getElementById('token-description').value.trim();
    const imageFile = document.getElementById('token-image').files[0];
    const twitter = document.getElementById('token-twitter').value.trim();
    const telegram = document.getElementById('token-telegram').value.trim();
    const website = document.getElementById('token-website').value.trim();

    try {
      const connection = await getConnectionWithFallback();
      const balance = await connection.getBalance(state.publicKey);
      const solBalance = balance / solanaWeb3.LAMPORTS_PER_SOL;
      console.log('Wallet balance:', solBalance, 'SOL');
      if (solBalance < 0.02) {
        throw new Error('Insufficient SOL. You need at least 0.02 SOL. Current: ' + solBalance.toFixed(4) + ' SOL');
      }

      state.mintKeypair = solanaWeb3.Keypair.generate();
      state.mintAddress = state.mintKeypair.publicKey.toBase58();
      console.log('Mint address:', state.mintAddress);

      // Step 1: IPFS
      currentStep = 1;
      setStep(1, 'active');
      const metadataUri = await uploadMetadata(name, symbol, description, imageFile, twitter, telegram, website);
      console.log('Metadata URI:', metadataUri);
      completeStep(1);

      // Step 2: Build TX
      currentStep = 2;
      setStep(2, 'active');
      const tx = await buildTransaction(metadataUri, name, symbol, state.mintKeypair, state.publicKey);
      console.log('Transaction built successfully');
      completeStep(2);

      // Step 3: Wallet approval
      currentStep = 3;
      setStep(3, 'active');

      // Step 4: Send
      currentStep = 4;
      state.txSignature = await signAndSend(tx, state.mintKeypair, connection);
      completeStep(3);
      setStep(4, 'active');
      completeStep(4);

      // Step 5: Confirmed
      currentStep = 5;
      setStep(5, 'active');
      completeStep(5);

      console.log('Token launched! Signature:', state.txSignature);

      // Transition to success after a brief moment
      setTimeout(() => showSuccess(), 800);

    } catch (err) {
      const msg = err.message || 'Unknown error';
      console.error('Launch error at step ' + currentStep + ':', err);

      if (msg.includes('User rejected') || msg.includes('user rejected')) {
        showProgressError('Transaction rejected in wallet');
        if (currentStep >= 3) setStep(3, 'error');
      } else {
        showProgressError(msg);
        if (currentStep > 0) setStep(currentStep, 'error');
      }

      // Show a back button on error
      setTimeout(() => {
        const errEl = document.getElementById('error-msg-progress');
        if (errEl.style.display !== 'none') {
          errEl.innerHTML += '<br/><button onclick="backToForm()" style="margin-top:10px;padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input);color:var(--text);cursor:pointer;font-family:var(--font);font-size:13px;font-weight:600">‚Üê Back to Form</button>';
        }
      }, 100);
    } finally {
      state.launching = false;
      launchBtn.disabled = false;
      launchBtn.textContent = 'Launch Token';
      validateForm();
    }
  };

  // ‚îÄ‚îÄ Back to form (from progress on error) ‚îÄ‚îÄ
  window.backToForm = function() {
    hideError();
    // Reset step icons
    for (let i = 1; i <= 5; i++) {
      const el = document.getElementById('step-' + i);
      el.className = 'step';
      el.querySelector('.step-icon').textContent = i;
    }
    showSection('section-form');
  };

  // ‚îÄ‚îÄ Success screen ‚îÄ‚îÄ
  function showSuccess() {
    document.getElementById('mint-addr').textContent = state.mintAddress;
    document.getElementById('link-pump').href = 'https://pump.fun/coin/' + state.mintAddress;
    document.getElementById('link-scan').href = 'https://solscan.io/token/' + state.mintAddress;
    showSection('section-success');
  }

  window.copyMint = function() {
    navigator.clipboard.writeText(state.mintAddress).then(() => {
      const el = document.getElementById('mint-addr');
      const original = el.textContent;
      el.textContent = 'Copied!';
      setTimeout(() => { el.textContent = original; }, 1500);
    });
  };

  window.resetForm = function() {
    hideError();
    document.getElementById('token-name').value = '';
    document.getElementById('token-symbol').value = '';
    document.getElementById('token-description').value = '';
    document.getElementById('token-image').value = '';
    document.getElementById('image-preview').style.display = 'none';
    document.getElementById('image-upload-text').innerHTML = '<strong>Click to upload</strong> or drag & drop<br/>PNG, JPG, GIF ‚Äî max 5MB';
    document.getElementById('token-twitter').value = '';
    document.getElementById('token-telegram').value = '';
    document.getElementById('token-website').value = '';
    state.mintKeypair = null;
    state.mintAddress = null;
    state.txSignature = null;
    for (let i = 1; i <= 5; i++) {
      const el = document.getElementById('step-' + i);
      el.className = 'step';
      el.querySelector('.step-icon').textContent = i;
    }
    showSection('section-form');
    validateForm();
  };

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  function initProvider() {
    console.log('[Init] initProvider called');
    const p = getProvider();
    if (p) {
      console.log('[Init] ‚úÖ Provider found, attaching event listeners');
      p.on('accountChanged', (pk) => {
        console.log('[Wallet] Account changed:', pk ? pk.toBase58() : 'disconnected');
        if (pk) { state.publicKey = pk; updateWalletUI(); }
        else { state.connected = false; state.publicKey = null; state.provider = null; updateWalletUI(); }
      });
      p.on('disconnect', () => {
        console.log('[Wallet] Disconnected event');
        state.connected = false; state.publicKey = null; state.provider = null; updateWalletUI();
      });
    } else {
      console.log('[Init] ‚ùå No provider found at init time');
    }
    updateWalletUI();
  }

  // Phantom injects after page load ‚Äî wait for it
  console.log('[Init] Page loaded, checking for Phantom...');
  if (getProvider()) {
    console.log('[Init] Phantom available immediately');
    initProvider();
  } else {
    console.log('[Init] Phantom not available yet, waiting...');
    window.addEventListener('phantom#initialized', () => {
      console.log('[Init] phantom#initialized event received');
      initProvider();
    }, { once: true });
    let attempts = 0;
    const poll = setInterval(() => {
      attempts++;
      if (getProvider()) {
        console.log('[Init] Phantom found after ' + attempts + ' poll attempts (' + (attempts * 200) + 'ms)');
        clearInterval(poll);
        initProvider();
      } else if (attempts >= 15) {
        console.log('[Init] ‚ùå Phantom NOT found after 3s of polling.');
        clearInterval(poll);
        initProvider();
      }
    }, 200);
  }
})();
</script>
</body>
</html>
